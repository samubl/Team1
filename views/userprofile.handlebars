<html>
<head>
	<title>J. Smith Homepage</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<!-- Linked css files -->
	<link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/bootstrap-theme.min.css" rel="stylesheet">
    <link href="/css/userprofile.css" rel="stylesheet">
	<link href="/css/constants.css" rel="stylesheet">
</head>
<body>
	<!-- bootstrap container for page content -->
	<div class="container">
		<!-- Back Button, Username -->
		<div class="backandname">
			<button type="button" onclick="goBack()" id="back">Back</button> 
			<h1>{{username}}</h1>
		</div>	
		<div class="spacer"></div>
		<div class="picandlinks">
			<!-- Profile Picture -->
			<div class="pic-container">
				<a><img src="{{picture}}"></a>
				<!-- Add a way to change it -->
			</div>
			<div class="sub">
				<!-- Links to Stats and Favorites user pages. Need to add link to Stats page and fill those pages -->
				<h3><a href="/{{username}}/statistics">Statistics </a><span class="glyphicon glyphicon-stats"></span></h3><hr>
				<h3><a href="/{{username}}/favorites">Favorites</a></h3>
			</div>
		</div>
		<!-- At a Glance Table -->
		<div class="glance">
			<ul>
				<li><h3>At a Glance</h3></li>
				<!-- Top 3 Genres -->
				<li><ul class="topgenres">
					<li>Top 3 Genres:</li>
					{{#with statistics}}
						{{#each genres}}
							<li class="genre">{{genre}}</li>
						{{/each}}
					{{/with}}
				</ul></li>
				<!-- Last Listened to Song and from where -->
				<li><ul class="lastlistened">
					{{#with statistics}}
						{{#with lastlistened}}
							<li>Last Listened to:</li>
							<li><a href="{{songlink}}">{{song}}</a> by <a href="{{artistlink}}">{{artist}}</a></li>
							<li>From <a href="{{sourcelink}}">{{source}}</a> at {{time}}</li>
						{{/with}}
					{{/with}}
				</ul></li>
				<!-- Linked Music Accounts, Add Button -->
				<li><ul>
					<li><h7 class="linked">Linked Accounts: </h7></li>
					<li><button type="button" id="addsource">Add Source</button></li>
				</ul></li>
			</ul>
			<!-- Where user will enter their source information -->
			<div class="sourceops">
				<form>
					<!-- Enter username: <input type="text" id="Enter username"><br>
					<input type="submit" id="submittedusername"><br> -->
        			<a href="{{username}}/connect" class="btn btn-primary" id="ConnectSpotify">Connect to Spotify</a>
                </form>
			</div>
		</div>
		<div class="logout">
			<h3><a href='/'>Log out</a></h3>
		</div>
		<!-- Navbar Section -->
		<ul class="navbar">
			<li><a href="/{{username}}" class="active">Account</a></li>
			<li><a href='/{{username}}/Friends'>Friends</a></li>
			<li><a href="/{{username}}/Statistics">Statistics</a></li>
			<li><a href='/{{username}}/Favorites'>Favorites</a></li>
		</ul>
	</div>

	<!-- connected javascript files -->
	<script src="/js/jquery-1.11.0.js"></script>	
	<script src="/js/bootstrap.js"></script>
	<script src="/js/bootstrap.min.js"></script>
	<script>
		function goBack(){
			window.history.back();
		}
	</script>
	<script>
		(function() {

			/**
			* Obtains parameters from the hash of the URL
			* @return Object
			*/
			function getHashParams() {
			var hashParams = {};
			var e, r = /([^&;=]+)=?([^&;]*)/g,
				q = window.location.hash.substring(1);
			while ( e = r.exec(q)) {
				hashParams[e[1]] = decodeURIComponent(e[2]);
			}
			return hashParams;
			}

			var params = getHashParams();

			var access_token = params.access_token,
								refresh_token = params.refresh_token,
								error = params.error;

			console.log(access_token);
			console.log(refresh_token);
			if (error) {
				alert('There was an error during the authentication');
			} 
			else {
				//$('#submittedusername').on("click", addSource);
				// $('#colorBtn').click(randomizeColors);
				if (access_token) {
					// render oauth info
					//oauthPlaceholder.innerHTML = oauthTemplate({
					//access_token: access_token,
					//refresh_token: refresh_token
					//});

					$.ajax({
						url: 'https://api.spotify.com/v1/me',
						headers: {
						'Authorization': 'Bearer ' + access_token
						},
						success: function(response) {
							console.log(response);
						$('.backandname').innerHTML = '<button type="button" onclick="goBack()" id="back">Back</button><h1>{{id}}</h1>';
						$("#ConnectSpotify").hide();
						//$('#login').hide();
						//$('#loggedin').show();
						}
					});
				} 
				else {
					// render initial screen
					//$('#login').show();
					//$('#loggedin').hide();
					console.log("No access token");
					$(".linked").hide();
					$("#addsource").hide();
					$("#ConnectSpotify").show();
				}
			}
		})();
	</script>
</body>
</html>
